---

- name: Initialise k8s (if required) on primary controller
  ansible.builtin.shell: >
    kubeadm init --pod-network-cidr={{ pod_cidr_nw }}
    --control-plane-endpoint={{ bootrap_host }}
    --upload-certs
  changed_when: false
  register: k8s_init
  when:
    - "'k8s_controllers' in group_names"
    - bootrap_host == inventory_hostname
    - not have_k8s_config.stat.exists

- name: Install the Calico Network Add-On
  ansible.builtin.command: >
    kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f
    https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml
  changed_when: false
  when:
    - "'k8s_controllers' in group_names"
    - bootrap_host == inventory_hostname
    - not have_k8s_config.stat.exists

- name: Get Cert
  ansible.builtin.command: kubeadm init phase upload-certs --upload-certs
  register: k8s_cert
  delegate_to: "{{ bootrap_host }}"
  changed_when: false
  when:
    - "'k8s_controllers' in group_names"
    - bootrap_host != inventory_hostname
    - not have_k8s_config.stat.exists

- name: Get Join Command
  ansible.builtin.command: kubeadm token create --print-join-command --ttl=10m
  register: k8s_join
  delegate_to: "{{ bootrap_host }}"
  changed_when: false
  when:
    - "'k8s' in group_names"
    - bootrap_host != inventory_hostname

- name: Controllers join if required
  ansible.builtin.command: >
    {{ k8s_join.stdout }} --control-plane
    --certificate-key {{ k8s_cert.stdout_lines[2] }}
  changed_when: false
  when:
    - "'k8s_controllers' in group_names"
    - bootrap_host != inventory_hostname
    - not have_k8s_config.stat.exists

- name: Nodes join cluster if required
  ansible.builtin.command: >
    {{ k8s_join.stdout }}
  changed_when: false
  when:
    - "'k8s_nodes' in group_names"
    - bootrap_host != inventory_hostname
    - not have_k8s_config.stat.exists

...
