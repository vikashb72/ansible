---

- name: Initialise k8s (if required) on primary controller
  ansible.builtin.shell: >
    kubeadm init --pod-network-cidr={{ pod_cidr_nw }}
    --control-plane-endpoint={{ bootrap_host }}
    --upload-certs
  changed_when: false
  register: k8s_init
  when:
    - "'k8s_controllers' in group_names"
    - bootrap_host == inventory_hostname
    - not have_k8s_config.stat.exists

- name: Install the Calico Network Add-On
  ansible.builtin.command: >
    kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f
    https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml
  changed_when: false
  when:
    - "'k8s_controllers' in group_names"
    - bootrap_host == inventory_hostname
    - not have_k8s_config.stat.exists

- name: Get Cert
  ansible.builtin.command: kubeadm init phase upload-certs --upload-certs
  register: k8s_cert
  delegate_to: "{{ bootrap_host }}"
  changed_when: false
  when:
    - "'k8s_controllers' in group_names"
    - bootrap_host != inventory_hostname
    - not have_k8s_config.stat.exists

- name: Get Join Command
  ansible.builtin.command: kubeadm token create --print-join-command --ttl=10m
  register: k8s_join
  delegate_to: "{{ bootrap_host }}"
  changed_when: false
  when:
    - "'k8s' in group_names"
    - bootrap_host != inventory_hostname

- name: Controllers join if required
  ansible.builtin.command: >
    {{ k8s_join.stdout }} --control-plane
    --certificate-key {{ k8s_cert.stdout_lines[2] }}
  changed_when: false
  when:
    - "'k8s_controllers' in group_names"
    - bootrap_host != inventory_hostname
    - not have_k8s_config.stat.exists

- name: Download helm key
  ansible.builtin.get_url:
    url: https://baltocdn.com/helm/signing.asc
    dest: /etc/apt/keyrings/helm-apt-keyring.asc
    mode: "0644"

- name: Add Kubernetes apt repository.
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/helm-apt-keyring.asc] https://baltocdn.com/helm/stable/debian/ all main"
    state: present

- name: Run the equivalent of "apt-get update"
  ansible.builtin.apt:
    update_cache: true

- name: Install packages
  ansible.builtin.package:
    name: helm
    state: present

- name: Ingress
  ansible.builtin.command: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.4/config/manifests/metallb-native.yaml
  delegate_to: "{{ bootrap_host }}"
  changed_when: false
  when:
    - "'k8s' in group_names"
    - bootrap_host == inventory_hostname

- name: Install kubectl-convert
  ansible.builtin.copy:
    src: kubectl-convert
    dest: /usr/local/bin/kubectl-convert
    owner: root
    mode: "0755"

- name: Copy configs
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/tmp/{{ item }}"
    owner: root
    mode: "0644"
  loop:
    - ipaddresses_pools.yaml
    - l2-advert.yaml
    - dashboard.yaml
    - dashboard.adminuser.yml

- name: Install
  ansible.builtin.command: kubectl apply -f /tmp/{{ item }}
  delegate_to: "{{ bootrap_host }}"
  changed_when: false
  loop:
    - ipaddresses_pools.yaml
    - l2-advert.yaml
    - dashboard.yaml
    - dashboard.adminuser.yml
  when:
    - "'k8s' in group_names"
    - bootrap_host == inventory_hostname

...
